openapi: 3.0.3
info:
  title: Trail Day REST API - Issue Tracker API
  version: 1.0.0
  description: |
    This API allows clients to perform discovery, health checks, and issue tracking.
    This API requires:
    - Setting the `X-Client-ID` header for all requests. Set this value: `my-client-id-123` to X-Client-ID field in Authorize area.
    - Authorizing using Bearer Token after login. Set token via Authorization tab or `Authorization` header.
    
    ## Versioning and Prefix
    - You can switch between versions using the path parameters like `/v1`, `/v2`, or omit when not needed.
    - Prefix can also be changed dynamically depending on environment setup.
    - For example, `/api/v1` or `/api/v2` or `/v1` or `/v2` depending on the setup. And all APIs are accessible in all combinations of:
      - No prefix (/)
      - Version only (/v1, /v2, etc.)
      - API prefix only (/api)
      - API prefix + version (/api/v1, /api/v2, etc.)

    - When version grows (v1, v2, and so on), as a future-proof solution, this setup allows:
      -	/health
      -	/api/health
      -	/v1/health
      -	/v2/health
      -	/api/v1/health
      -	/api/v2/health
      - etc...
      
    * All endpoints require `X-Client-ID` (Value: `my-client-id-123`).  
    * Some endpoints require Bearer Token from login response.


servers:
  - url: "{protocol}://{host}:{port}{api_prefix}{api_version}"
    description: Configurable Server
    variables:
      protocol:
        default: http
        enum:
          - "http"
          - "https"
      host:
        default: localhost
        enum:
          - localhost
          - api.testilo.com
      port:
        default: "8080"
        enum:
          - "8080"
          - "443"
          - "80"
      api_prefix:
        default: /api
        enum:
          - /api
          - /core
          - ''
      api_version:
        default: /v1
        enum:
          - /v1
          - /v2
          - ''
  
  - url: "{protocol}://{hostname}:{port}"
    description: Legacy/Non-prefixed APIs
    variables:
      protocol:
        default: https
      hostname:
        default: localhost
      port:
        default: '8080'

security:
  - BearerAuth: []
  - X-Client-ID: []

tags:
  - name: System
    description: System related operations
  - name: Auth
    description: Authentication related operations
  - name: Issues
    description: CRUD and filter operations for issue tracking

paths:  
  /:
    get:
      summary: "Service Discovery Endpoint"
      tags: [System]
      operationId: getDiscovery
      responses:
        '400':
          $ref: '#/components/responses/MissingClientIdHeader'
        '403':
          $ref: '#/components/responses/InvalidClientId'
        '200':
          description: Service discovery details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscoveryResponse'
            

  /health:
    get:
      summary: "Health Check of API Server"
      tags: [System]
      operationId: getHealthCheck
      responses:
        '400':
          $ref: '#/components/responses/MissingClientIdHeader'
        '403':
          $ref: '#/components/responses/InvalidClientId'
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/BaseResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          status:
                            type: string
                            example: UP
        '503':
          description: Service unavailable
  /auth/login:
    post:
      tags: [Auth]
      summary: "User login and token generation (Task 5)"
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '400':
          $ref: '#/components/responses/MissingClientIdHeader'
        '403':
          $ref: '#/components/responses/InvalidClientId'
        '200':
          description: Successfully authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials

  /issues:
    post:
      tags:
        - Issues
      summary: "Create a new issue (Task 1)"
      description: Creates a new issue with a title, description, and optional assignee.
      operationId: createIssue
      security:
        - BearerAuth: []
        - X-Client-ID: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIssueRequest'
            example:
              title: "Bug in issue-service"
              description: "Ah snap :("
              status: "open"
              priority: "medium"
              assignee: null
      responses:
        '201':
          description: Issue successfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssueResponse'
        '400':
          $ref: '#/components/responses/MissingClientIdHeader'
        '403':
          $ref: '#/components/responses/InvalidClientId'
        '401':
          description: Unauthorized - Invalid or expired token
        '500':
          description: Internal Server Error
    get:
      summary: "Retrieve all issues (Task 2)"
      tags: [Issues]
      operationId: getAllIssues
      responses:
        '400':
          $ref: '#/components/responses/MissingClientIdHeader'
        '403':
          $ref: '#/components/responses/InvalidClientId'
        '200':
          description: List of issues
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/BaseResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Issue'

  /issues/{id}:
    get:
      tags: [Issues]
      summary: "Get issue by ID (Task 2)"
      operationId: getIssueById
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '400':
          $ref: '#/components/responses/MissingClientIdHeader'
        '403':
          $ref: '#/components/responses/InvalidClientId'
        '200':
          description: Issue found
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/BaseResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Issue'
        '404':
          description: Issue not found

    put:
      tags:
        - Issues
      summary: Update an existing issue
      description: Update the title, description, status, priority, or assignee of a specific issue.
      operationId: updateIssue
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier for the issue to update.
        - name: X-Client-ID
          in: header
          required: true
          schema:
            type: string
          description: Unique client ID for API access.
      security:
        - BearerAuth: []
        - X-Client-ID: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateIssueRequest'
            example:
              title: "UI bug in dashboard"
              description: "Fix the alignment in header"
              status: "in_progress"
              priority: "high"
              assignee: "user123"
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalServerError'


components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    X-Client-ID:
      type: apiKey
      in: header
      name: X-Client-ID

  responses:
    Success:
      description: Successful operation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'
            
    Created:
      description: Resource created successfully
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    Accepted:
      description: Request accepted for processing
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    NoContent:
      description: No content to return
      content: {}

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    Conflict:
      description: Conflict occurred (e.g., duplicate resource)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    UnprocessableEntity:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    ServiceUnavailable:
      description: Service temporarily unavailable
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BaseResponse'

    Unauthorized:
      description: Authentication error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/UnauthorizedResponse'

    Forbidden:
      description: Forbidden - Invalid X-Client-ID
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ForbiddenResponse'

    BadRequest:
      description: Bad Request - Missing or invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/BadRequestResponse'

    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/InternalServerErrorResponse'
            
    MissingClientIdHeader:
      description: Missing X-Client-ID header
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            type: "about:blank"
            title: "Missing X-Client-ID header"
            status: 400
            detail: "Missing X-Client-ID header"
            instance: "/api/v1/issues/1"
            errors:
              - field: "x-client-id"
                message: "X-Client-ID header is required"
                code: "missing_client_id"
            success: false

    InvalidClientId:
      description: Invalid X-Client-ID header
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            type: "about:blank"
            title: "Invalid X-Client-ID"
            status: 403
            detail: "Invalid X-Client-ID"
            instance: "/api/v1/issues/1"
            errors: null
            success: false

  schemas:
    AuthErrorTypeEnum:
      type: string
      description: Type of authentication error
      enum:
        - about:blank
        - token-expired
        - invalid-token
      example: about:blank

    ClientErrorTypeEnum:
      type: string
      description: Type of client error
      enum:
        - about:blank
        - missing-client-id
        - invalid-client-id
      example: missing-client-id

    BaseResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          nullable: true
        errors:
          type: array
          nullable: true
          items:
            type: object
            properties:
              field:
                type: string
                example: x-client-id
              message:
                type: string
                example: X-Client-ID header is required
              code:
                type: string
                example: missing_client_id

    UnauthorizedResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            type:
              $ref: '#/components/schemas/AuthErrorTypeEnum'
            title:
              type: string
              example: Authentication Error
            status:
              type: integer
              example: 401
            detail:
              type: string
              example: Authentication Error
            instance:
              type: string
              example: /api/v1/issues/1

    ForbiddenResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            type:
              $ref: '#/components/schemas/ClientErrorTypeEnum'
            title:
              type: string
              example: Invalid X-Client-ID
            status:
              type: integer
              example: 403
            detail:
              type: string
              example: Invalid X-Client-ID
            instance:
              type: string
              example: /api/v1/issues/1

    BadRequestResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            type:
              $ref: '#/components/schemas/ClientErrorTypeEnum'
            title:
              type: string
              example: Missing X-Client-ID header
            status:
              type: integer
              example: 400
            detail:
              type: string
              example: Missing X-Client-ID header
            instance:
              type: string
              example: /api/v1/issues/1

    InternalServerErrorResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            type:
              type: string
              example: about:blank
            title:
              type: string
              example: Internal Server Error
            status:
              type: integer
              example: 500
            detail:
              type: string
              example: An unexpected error occurred
            instance:
              type: string
              example: /api/v1/issues/1
    
    ErrorDetail:
      type: object
      properties:
        field:
          type: string
        message:
          type: string
        code:
          type: string

    ErrorResponse:
      type: object
      properties:
        type:
          type: string
          example: "about:blank"
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
        success:
          type: boolean
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'

    MissingClientIdError:
      type: object
      properties:
        type:
          type: string
          example: about:blank
        title:
          type: string
          example: Missing X-Client-ID header
        status:
          type: integer
          example: 400
        detail:
          type: string
          example: Missing X-Client-ID header
        instance:
          type: string
          example: /api/v1/issues/1
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
        success:
          type: boolean
          example: false

    InvalidClientIdError:
      type: object
      properties:
        type:
          type: string
          example: about:blank
        title:
          type: string
          example: Invalid X-Client-ID
        status:
          type: integer
          example: 403
        detail:
          type: string
          example: Invalid X-Client-ID
        instance:
          type: string
          example: /api/v1/issues/1
        errors:
          type: array
          nullable: true
          items:
            type: object
        success:
          type: boolean
          example: false

    DiscoveryResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                discovery:
                  type: string
                  example: http://localhost:8080

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: admin@example.com
        password:
          type: string
          format: password
          example: Password123

    LoginResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI...

    CreateIssueRequest:
      type: object
      required:
        - title
        - description
        - status
        - priority
      properties:
        title:
          type: string
          example: "Bug in issue-service"
        description:
          type: string
          example: "Ah snap :("
        status:
          $ref: '#/components/schemas/IssueStatusEnum'
        priority:
          $ref: '#/components/schemas/IssuePriorityEnum'
        assignee:
          type: string
          nullable: true
          example: "123"

    UpdateIssueRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 255
        description:
          type: string
        status:
          $ref: '#/components/schemas/IssueStatusEnum'
        priority:
          $ref: '#/components/schemas/IssuePriorityEnum'
        assignee:
          type: string
          nullable: true
      required:
        - title
        - description

    IssueStatusEnum:
      type: string
      description: Status of the issue
      enum:
        - open
        - in_progress
        - resolved
        - closed
      example: "open"

    IssuePriorityEnum:
      type: string
      description: Priority of the issue
      enum:
        - low
        - medium
        - high
        - critical
      example: "medium"
    


    IssueResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                id:
                  type: string
                  example: "issue_001"
                title:
                  type: string
                description:
                  type: string
                status:
                  type: string
                priority:
                  type: string
                assignee:
                  type: string
                  nullable: true
                createdAt:
                  type: string
                  format: date-time
                updatedAt:
                  type: string
                  format: date-time

    Issue:
      type: object
      properties:
        id:
          type: string
          example: abc123
        title:
          type: string
          example: Bug in login
        description:
          type: string
          example: When logging in, the page crashes.
        status:
          type: string
          enum: [open, in_progress, resolved, closed]
          example: open
        priority:
          type: string
          enum: [low, medium, high]
          example: high
        createdAt:
          type: string
          format: date-time
          example: 2025-05-25T08:00:00Z
        updatedAt:
          type: string
          format: date-time
          example: 2025-05-25T09:00:00Z

    IssueFilter:
      type: object
      properties:
        status:
          type: string
          example: open
        priority:
          type: string
          example: high
